<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<div class="event-details-page">
  <div class="container py-5">
    <div class="row">
      <div class="col-lg-10 mx-auto">

        <!-- Event Hero Section -->
        <div class="event-hero mb-5">
          <% if @event.image.attached? %>
            <div class="event-hero-image mb-4">
              <%= image_tag @event.image, alt: @event.title %>
            </div>
          <% end %>

          <div class="event-hero-content">
            <% if @event.topic %>
              <span class="topic-badge mb-3">
                <%= @event.topic.topic_name %>
              </span>
            <% end %>

            <h1 class="event-title"><%= @event.title %></h1>

            <% if @event.description.present? %>
              <p class="event-description">
                <%= @event.description %>
              </p>
            <% end %>
          </div>
        </div>

        <!-- Event Info Grid -->
        <div class="event-info-grid mb-5">
          <div class="info-card">
            <div class="info-icon">üìÖ</div>
            <div class="info-content">
              <div class="info-label">Date & Time</div>
              <div class="info-value"><%= @event.date_time ? @event.date_time.strftime("%B %d, %Y at %I:%M %p") : "TBD" %></div>
            </div>
          </div>

          <div class="info-card">
            <div class="info-icon">üìç</div>
            <div class="info-content">
              <div class="info-label">Location</div>
              <div class="info-value"><%= @event.location || "To be announced" %></div>
            </div>
          </div>

          <div class="info-card">
            <div class="info-icon">üë•</div>
            <div class="info-content">
              <div class="info-label">Attendees</div>
              <div class="info-value"><%= @event.confirmations.count %><% if @event.max_capacity %> / <%= @event.max_capacity %><% end %></div>
            </div>
          </div>

          <div class="info-card">
            <div class="info-icon">üë§</div>
            <div class="info-content">
              <div class="info-label">Organizer</div>
              <div class="info-value"><%= @event.user&.name || "Friend Fusion" %></div>
            </div>
          </div>
        </div>

        <!-- Map Section -->
        <% if @event.location.present? %>
          <div class="map-section mb-5">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
              </svg>
              Event Location
            </h3>
            <div id="event-map" data-location="<%= @event.location %>"></div>
          </div>
        <% end %>

        <!-- Action Buttons -->
        <div class="action-buttons-section mb-5">
          <% if user_signed_in? %>
            <!-- Event Creator Actions -->
            <% if policy(@event).edit? %>
              <%= link_to edit_event_path(@event), class: "btn-action btn-secondary-action" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                  <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                </svg>
                Edit Event
              <% end %>

              <%= button_to event_path(@event),
                    method: :delete,
                    class: "btn-action btn-danger-action",
                    data: { turbo_confirm: "Are you sure you want to delete this event? This action cannot be undone." } do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                  <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
                Delete Event
              <% end %>
            <% end %>

            <% user_confirmed = @event.confirmations.exists?(user: current_user) %>

            <% if user_confirmed %>
              <%
                # Ensure chat exists for this event
                chat = @event.chat || @event.create_chat
              %>
              <%= link_to chat_path(chat), class: "btn-action btn-primary-action" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                </svg>
                Go to Event Chat
              <% end %>

              <%= link_to new_event_feedback_path(@event), class: "btn-action btn-secondary-action" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                </svg>
                Give Feedback
              <% end %>

              <%= button_to event_confirmation_path(@event, @event.confirmations.find_by(user: current_user)),
                    method: :delete,
                    class: "btn-action btn-danger-action",
                    data: { turbo_confirm: "Are you sure you want to leave this event?" } do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                  <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
                Leave Event
              <% end %>
            <% else %>
              <%= button_to event_confirmations_path(@event),
                    method: :post,
                    class: "btn-action btn-join-event" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                </svg>
                Join Event
              <% end %>
            <% end %>
          <% else %>
            <%= link_to new_user_session_path, class: "btn-action btn-join-event" do %>
              Sign in to Join
            <% end %>
          <% end %>
        </div>

        <!-- Confirmed Attendees -->
        <% if @event.confirmations.any? %>
          <div class="attendees-section">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
                <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
              </svg>
              Confirmed Attendees
              <span class="count-badge"><%= @event.confirmations.count %></span>
            </h3>
            <div class="attendees-grid">
              <% @event.users.each do |user| %>
                <div class="attendee-badge">
                  <div class="attendee-avatar">
                    <%= user.name&.first&.upcase || '?' %>
                  </div>
                  <span class="attendee-name"><%= user.name %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

      </div>
    </div>
  </div>
</div>

<style>
  .event-details-page {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
  }

  .event-hero {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  }

  .event-hero-image {
    width: 100%;
    height: 400px;
    overflow: hidden;
  }

  .event-hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .event-hero-content {
    padding: 2.5rem;
  }

  .topic-badge {
    display: inline-block;
    padding: 0.5rem 1.25rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .event-title {
    font-size: 3rem;
    font-weight: 800;
    color: #1a202c;
    margin: 1.5rem 0;
    line-height: 1.2;
  }

  .event-description {
    font-size: 1.25rem;
    color: #4a5568;
    line-height: 1.8;
    margin: 0;
  }

  .event-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .info-card {
    background: white;
    border-radius: 15px;
    padding: 1.75rem;
    display: flex;
    align-items: center;
    gap: 1.25rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
  }

  .info-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
  }

  .info-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
  }

  .info-content {
    flex: 1;
  }

  .info-label {
    font-size: 0.875rem;
    color: #718096;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .info-value {
    font-size: 1.125rem;
    color: #2d3748;
    font-weight: 600;
  }

  .action-buttons-section {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
  }

  .btn-action {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 1rem;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .btn-primary-action {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-primary-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    color: white;
  }

  .btn-secondary-action {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
  }

  .btn-secondary-action:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
  }

  .btn-danger-action {
    background: white;
    color: #e53e3e;
    border: 2px solid #e53e3e;
  }

  .btn-danger-action:hover {
    background: #e53e3e;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(229, 62, 62, 0.3);
  }

  .btn-join-event {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    padding: 1.25rem 3rem;
    font-size: 1.25rem;
  }

  .btn-join-event:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
    color: white;
  }

  .map-section {
    background: white;
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  }

  #event-map {
    height: 450px;
    min-height: 450px;
    width: 100%;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    background: #f5f7fa;
  }

  .attendees-section {
    background: white;
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a202c;
    margin-bottom: 2rem;
  }

  .count-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.375rem 1rem;
    border-radius: 50px;
    font-size: 1rem;
    font-weight: 600;
  }

  .attendees-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.25rem;
  }

  .attendee-badge {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    transition: all 0.3s ease;
  }

  .attendee-badge:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  }

  .attendee-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.125rem;
    flex-shrink: 0;
  }

  .attendee-name {
    font-weight: 600;
    color: #2d3748;
    font-size: 1rem;
  }

  @media (max-width: 768px) {
    .event-title {
      font-size: 2rem;
    }

    .event-info-grid {
      grid-template-columns: 1fr;
    }

    .action-buttons-section {
      flex-direction: column;
    }

    .btn-action {
      width: 100%;
      justify-content: center;
    }

    .attendees-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  function initializeEventMap() {
    const mapElement = document.getElementById('event-map');

    if (mapElement && typeof L !== 'undefined') {
      const location = mapElement.dataset.location;

      // Clear any existing map instance
      if (mapElement._leaflet_id) {
        mapElement._leaflet_id = undefined;
        mapElement.innerHTML = '';
      }

      // Initialize the map with a default view
      const map = L.map('event-map').setView([51.505, -0.09], 13);

      // Add OpenStreetMap tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      // Geocode the location using Nominatim
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);

            // Center the map on the location
            map.setView([lat, lon], 15);

            // Add a marker
            L.marker([lat, lon])
              .addTo(map)
              .bindPopup(`<b>${location}</b>`)
              .openPopup();
          } else {
            // If geocoding fails, show an error message
            mapElement.innerHTML = '<div style="padding: 2rem; text-align: center; color: #718096;">Unable to locate address on map. Please verify the location.</div>';
          }
        })
        .catch(error => {
          console.error('Error geocoding location:', error);
          mapElement.innerHTML = '<div style="padding: 2rem; text-align: center; color: #718096;">Error loading map. Please try again later.</div>';
        });
    } else if (mapElement && typeof L === 'undefined') {
      // Leaflet not loaded yet, wait a bit and retry
      setTimeout(initializeEventMap, 100);
    }
  }

  // Listen for Turbo events
  document.addEventListener('turbo:load', initializeEventMap);
  document.addEventListener('turbo:frame-load', initializeEventMap);

  // Also try on DOMContentLoaded for initial page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEventMap);
  } else {
    initializeEventMap();
  }
</script>
