<div class="container mt-5">
  <div class="row">
    <div class="col-lg-8 mx-auto">

      <!-- Event Header -->
      <div class="text-center mb-4">
        <h1 class="display-5 fw-bold mb-3"><%= @event.title %></h1>

        <% if @event.topic %>
          <span class="badge bg-primary mb-3"><%= @event.topic.topic_name %></span>
        <% end %>

        <% if @event.description.present? %>
          <p class="lead text-muted">
            <%= @event.description %>
          </p>
        <% end %>
      </div>

      <!-- Event Image -->
      <% if @event.image.attached? %>
        <div class="mb-4 text-center">
          <%= image_tag @event.image, class: "img-fluid rounded", style: "max-height: 400px; object-fit: cover;" %>
        </div>
      <% end %>

      <!-- Event Details Card -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Event Details</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <strong>ğŸ“… Date & Time:</strong><br>
              <%= @event.date_time ? @event.date_time.strftime("%B %d, %Y at %I:%M %p") : "TBD" %>
            </div>

            <div class="col-md-6">
              <strong>ğŸ“ Location:</strong><br>
              <%= @event.location || "To be announced" %>
            </div>

            <div class="col-md-6">
              <strong>ğŸ‘¥ Attendees:</strong><br>
              <%= @event.confirmations.count %><% if @event.max_capacity %> / <%= @event.max_capacity %><% end %>
            </div>

            <div class="col-md-6">
              <strong>ğŸ‘¤ Organizer:</strong><br>
              <%= @event.user&.name || "Friend Fusion" %>
            </div>
            <%= javascript_include_tag "https://maps.googleapis.com/maps/api/js" %>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2 mb-4 flex-wrap justify-content-center">
        <% if user_signed_in? %>
          <% user_confirmed = @event.confirmations.exists?(user: current_user) %>

          <% if user_confirmed %>
            <%= button_to "Leave Event",
                  event_confirmation_path(@event, @event.confirmations.find_by(user: current_user)),
                  method: :delete,
                  class: "btn btn-outline-danger",
                  data: { turbo_confirm: "Are you sure you want to leave this event?" } %>

            <% if @event.chat %>
              <%= link_to "Go to Chat", chat_path(@event.chat), class: "btn btn-primary" %>
            <% end %>
          <% else %>
            <%= button_to "Join Event",
                  event_confirmations_path(@event),
                  method: :post,
                  class: "btn btn-success btn-lg" %>
          <% end %>

          <%= link_to "Give Feedback", new_event_feedback_path(@event), class: "btn btn-outline-secondary" %>
        <% else %>
          <%= link_to "Sign in to Join", new_user_session_path, class: "btn btn-primary btn-lg" %>
        <% end %>
      </div>

      <!-- Confirmed Attendees -->
      <% if @event.confirmations.any? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Confirmed Attendees (<%= @event.confirmations.count %>)</h5>
          </div>
          <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
              <% @event.users.each do |user| %>
                <span class="badge bg-light text-dark border"><%= user.name %></span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Conversation Starters Section -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Conversation Starters ğŸ’¬</h5>
        </div>
        <div class="card-body">
          <!-- Button to trigger the AI call -->
          <%= button_to "Generate Starters",
                conversation_starters_event_path(@event),
                method: :get,
                form: { data: { turbo_stream: true } },
                class: "btn btn-secondary",
                id: "starter-button" %>

          <!-- Spinner (hidden by default) -->
          <div id="starter-loading" class="text-muted mt-2" style="display:none;">
            <div class="spinner-border spinner-border-sm"></div>
            Generating ideas...
          </div>

          <!-- Placeholder where AI starters will appear -->
          <div id="conversation-starters" class="mt-3"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  document.addEventListener("turbo:before-fetch-request", (e) => {
    const target = e.target;

    // Only for conversation starter button
    if (target.id === "starter-button") {
      document.getElementById("starter-loading").style.display = "block";
    }
  });
</script>
