
<div class="event-details-page">
  <div class="container py-5">
    <div class="row">
      <div class="col-lg-10 mx-auto">

        <!-- Event Completed Notice -->
        <% if @event.event_ended? %>
          <div class="event-completed-notice">
            <div class="completed-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
              </svg>
            </div>
            <div class="completed-content">
              <h4 class="completed-title">This Event Has Been Completed</h4>
              <p class="completed-text">This event ended on <%= @event.end_time.strftime("%B %d, %Y at %I:%M %p") %>. Thank you to everyone who participated!</p>
            </div>
          </div>
        <% end %>

        <!-- Event Hero Section -->
        <div class="event-hero mb-5">
          <% if @event.image.attached? %>
            <div class="event-hero-image mb-4">
              <%= image_tag @event.image, alt: @event.title %>
            </div>
          <% end %>

          <div class="event-hero-content">
            <% if @event.topic %>
              <span class="topic-badge mb-3">
                <%= @event.topic.topic_name %>
              </span>
            <% end %>

            <h1 class="event-title"><%= @event.title %></h1>

            <% if @event.description.present? %>
              <p class="event-description">
                <%= @event.description %>
              </p>
            <% end %>
          </div>
        </div>

      <!-- Event Details Card -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Event Details</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <strong>üìÖ Date:</strong><br>
              <%= @event.date_time ? @event.date_time.strftime("%B %d, %Y") : "TBD" %>

              <div class="mt-2"></div>

              <strong>‚è∞ Time:</strong>
              <%= @event.time ? @event.time.strftime("%I:%M %p") : "TBD" %>
            </div>
          </div>

          <div class="info-card">
            <div class="info-icon">üìç</div>
            <div class="info-content">
              <div class="info-label">Location</div>
              <div class="info-value"><%= @event.location || "To be announced" %></div>
            </div>
          </div>

          <div class="info-card">
            <div class="info-icon">üë•</div>
            <div class="info-content">
              <div class="info-label">Attendees</div>
              <div class="info-value"><%= @event.confirmations.count %><% if @event.max_capacity %> / <%= @event.max_capacity %><% end %></div>
            </div>
          </div>

          <div class="info-card">
            <div class="info-icon">üë§</div>
            <div class="info-content">
              <div class="info-label">Organizer</div>
              <div class="info-value">
                <% if @event.user.present? %>
                  <%= link_to @event.user.name, organizer_path(@event.user), class: "organizer-link" %>
                <% else %>
                  Friend Fusion
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Map Section -->
        <% if @event.location.present? %>
          <div class="map-section mb-5">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
              </svg>
              Event Location
            </h3>

            <div class="map-container">
              <div id="event-map" data-location="<%= @event.location %>"></div>
            </div>
          </div>
        <% end %>


        <!-- Action Buttons -->
        <div class="action-buttons-section mb-5">
          <% if user_signed_in? %>
            <!-- Event Creator Actions -->
            <% if policy(@event).edit? %>
              <%= link_to edit_event_path(@event), class: "btn-action btn-secondary-action" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                  <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                </svg>
                Edit Event
              <% end %>

              <%= button_to event_path(@event),
                    method: :delete,
                    class: "btn-action btn-danger-action",
                    data: { turbo_confirm: "Are you sure you want to delete this event? This action cannot be undone." } do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                  <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
                Delete Event
              <% end %>
            <% end %>

            <% user_confirmed = @event.confirmations.exists?(user: current_user) %>

            <% if user_confirmed %>
              <%
                # Ensure chat exists for this event
                chat = @event.chat || @event.create_chat
              %>
              <%= link_to chat_path(chat), class: "btn-action btn-primary-action" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                </svg>
                Go to Event Chat
              <% end %>

              <% if @event.event_ended? %>
                <%= link_to new_event_feedback_path(@event), class: "btn-action btn-secondary-action" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                  </svg>
                  Give Feedback
                <% end %>
              <% end %>

              <%= button_to event_confirmation_path(@event, @event.confirmations.find_by(user: current_user)),
                    method: :delete,
                    class: "btn-action btn-danger-action",
                    data: { turbo_confirm: "Are you sure you want to leave this event?" } do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                  <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
                Leave Event
              <% end %>
            <% else %>
              <% unless @event.event_ended? %>
                <%= button_to event_confirmations_path(@event),
                      method: :post,
                      class: "btn-action btn-join-event" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                  </svg>
                  Join Event
                <% end %>
              <% end %>
            <% end %>
          <% else %>
            <%= link_to new_user_session_path, class: "btn-action btn-join-event" do %>
              Sign in to Join
            <% end %>
          <% end %>
        </div>

        <!-- Confirmed Attendees -->
        <% if @event.confirmations.any? %>
          <div class="attendees-section">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
                <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
              </svg>
              Confirmed Attendees
              <span class="count-badge"><%= @event.confirmations.count %></span>
            </h3>
            <div class="attendees-grid">
              <% @event.users.each do |user| %>
                <div class="attendee-badge">
                  <div class="attendee-avatar">
                    <%= user.name&.first&.upcase || '?' %>
                  </div>
                  <span class="attendee-name"><%= user.name %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Event Feedbacks -->
        <% if @event.feedbacks.any? %>
          <div class="feedbacks-section mt-5">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
              </svg>
              Event Feedback
              <span class="count-badge"><%= @event.feedback_count %></span>
              <span class="average-rating-badge">‚≠ê <%= @event.average_rating %> average</span>
            </h3>
            <div class="feedbacks-grid">
              <% @event.feedbacks.order(created_at: :desc).each do |feedback| %>
                <div class="feedback-card">
                  <div class="feedback-header">
                    <div class="feedback-user">
                      <div class="feedback-avatar">
                        <%= feedback.user.name&.first&.upcase || '?' %>
                      </div>
                      <div>
                        <div class="feedback-user-name"><%= feedback.user.name %></div>
                        <div class="feedback-date"><%= feedback.created_at.strftime("%b %d, %Y") %></div>
                      </div>
                    </div>
                    <div class="feedback-rating">
                      <%= "‚≠ê" * feedback.rating %>
                    </div>
                  </div>
                  <div class="feedback-comment">
                    <%= feedback.comment %>
                  </div>
                  <% if feedback.pictures.attached? %>
                    <div class="feedback-photos">
                      <% feedback.pictures.each do |picture| %>
                        <div class="feedback-photo">
                          <%= image_tag picture, alt: "Event photo" %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

      </div>
    </div>
  </div>
</div>

<script>
  function initMap() {
    const mapElement = document.getElementById("event-map");
    if (!mapElement) return;

    const address = mapElement.dataset.location;
    const geocoder = new google.maps.Geocoder();

    geocoder.geocode({ address: address }, function(results, status) {
      if (status === "OK") {
        const map = new google.maps.Map(mapElement, {
          zoom: 14,
          center: results[0].geometry.location
        });

        new google.maps.Marker({
          position: results[0].geometry.location,
          map: map
        });
      } else {
        console.error("Geocode failed: " + status);
        mapElement.innerHTML = "Map cannot be loaded for this location.";
      }
    });
  }

  // Initialize map on first load & Turbo page visits
  document.addEventListener("turbo:load", function() {
    if (typeof google !== "undefined" && google.maps) {
      initMap();
    }
  });
</script>

<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_SERVER_KEY'] %>&callback=initMap">
</script>
