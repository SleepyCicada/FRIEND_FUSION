<%# <% content_for :meta_title, "#{@offer.name} is on #{DEFAULT_META["meta_product_name"]}" %>
<%# <% content_for :meta_description, @offer.description %>
<%# <% content_for :meta_image, cl_image_path(@offer.photo.path) %>

<%= turbo_stream_from @event %>

<div class="event-details-page">
  <div class="container pt-3 pb-3">
    <div class="row">
      <div class="col-lg-10 mx-auto">
        <!-- Header Buttons Container -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <!-- Go Back Button -->
          <div>
            <button class="go-back-button btn btn-light p-1" onclick="goBack()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
              </svg>
            </button>
          </div>

  <!-- Edit/Delete Buttons -->
      <div class="d-flex align-items-center gap-2">
        <% if policy(@event).edit? %>
          <%= link_to edit_event_path(@event), class: "btn-action btn-secondary-action p-1 action-btn d-flex align-items-center justify-content-center" do %>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
              <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
            </svg>
          <% end %>

          <%= button_to event_path(@event),
                method: :delete,
                class: "btn-action btn-danger-action p-1 action-btn d-flex align-items-center justify-content-center",
                data: { turbo_confirm: "Are you sure you want to delete this event? This action cannot be undone." } do %>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
              <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
          <% end %>
        <% end %>
      </div>
    </div>

        <script>
        function goBack() {
          // Check if user just created this event (coming from new event form)
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('created')) {
            // Redirect to events index instead of going back to the form
            window.location.href = "<%= events_path %>";
          } else if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "/";
          }
        }
        </script>

        <!-- Event Completed Notice -->
        <% if @event.event_ended? %>
          <div class="event-completed-notice">
            <div class="completed-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
              </svg>
            </div>
            <div class="completed-content">
              <h4 class="completed-title">This Event Has Been Completed</h4>
              <p class="completed-text">This event ended on <span class="local-time" data-utc="<%= @event.end_time.utc.iso8601 %>"><%= @event.end_time.strftime("%B %d, %Y at %I:%M %p") %></span>. Thank you to everyone who participated!</p>
            </div>
          </div>
        <% end %>

        <!-- Event Hero Section -->
    <div class="event-hero mb-4 text-center">
      <% if @event.image.attached? %>
        <div class="event-hero-image mb-1">
          <%= image_tag @event.image, alt: @event.title, class: "img-fluid rounded" %>
        </div>
      <% end %>

      <div class="event-hero-content">
        <% if @event.topic %>
          <span class="topic-badge mb-2 d-inline-block">
            <%= @event.topic.topic_name %>
          </span>
        <% end %>

        <h1 class="event-title mb-1"><%= @event.title %></h1>

        <% if @event.description.present? %>
          <p class="event-description mb-0">
            <%= @event.description %>
          </p>
        <% end %>
      </div>
    </div>

  <!-- Event Details Section -->
    <div class="event-details-section">
      <h3 class="section-title">
        <!-- Calendar Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
          <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2
                  2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1
                  5v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5H1z"/>
        </svg>
        Event Details
      </h3>

      <!-- Grid -->
      <div class="details-grid">

        <!-- Date -->
        <div class="detail-item">
          <div class="detail-icon">üìÖ</div>
          <div>
            <div class="detail-label">Date and Time</div>
            <div class="detail-value">
              <% if @event.date_time %>
                <span class="local-time" data-utc="<%= @event.date_time.utc.iso8601 %>">
                  <%= @event.date_time.strftime("%b %d, %Y at %I:%M %p") %>
                </span>
              <% else %>
                TBD
              <% end %>
            </div>
          </div>
        </div>

        <!-- Location -->
        <div class="detail-item">
          <div class="detail-icon">üìç</div>
          <div>
            <div class="detail-label">Location</div>
            <div class="detail-value"><%= @event.location || "To be announced" %></div>
          </div>
        </div>

        <!-- Attendees -->
        <div class="detail-item">
          <div class="detail-icon">üë•</div>
          <div>
            <div class="detail-label">Attendees</div>
            <div class="detail-value">
              <%
                # Count confirmations + organizer if they don't have a confirmation
                total_count = @event.confirmations.count
                total_count += 1 if @event.user.present? && !@event.users.include?(@event.user)
              %>
              <%= total_count %>
              <% if @event.max_capacity %>
                / <%= @event.max_capacity %>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Organizer -->
        <div class="detail-item">
          <div class="detail-icon">üë§</div>
          <div>
            <div class="detail-label">Organizer</div>
            <div class="detail-value">
              <% if @event.user.present? %>
                <%= link_to @event.user.name, organizer_path(@event.user), class: "organizer-link" %>
              <% else %>
                Friend Fusion
              <% end %>
            </div>
          </div>
        </div>

      </div>
    </div><!-- end main card -->

        <!-- Map Section -->
        <% if @event.location.present? && !@event.online? %>
          <div class="map-section mb-1">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
              </svg>
              Event Location
            </h3>

            <div class="map-container">
              <div id="event-map" data-location="<%= @event.location %>" style="height: 300px;"></div>
            </div>
          </div>

          <% if ENV['GOOGLE_API_SERVER_KEY'].present? %>
            <script async defer loading="lazy"
                    src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_SERVER_KEY'] %>&callback=initMaps">
            </script>
          <% else %>
            <p style="color: red;">Google Maps API key is missing.</p>
          <% end %>
        <% end %>

        <!-- Action Buttons -->
        <% user_confirmed = user_signed_in? && @event.confirmations.exists?(user: current_user) %>
        <%= render "events/action_buttons", event: @event, user_confirmed: user_confirmed %>

        <!-- Confirmed Attendees -->
        <% if @event.confirmations.any? || @event.user.present? %>

          <%
            # Get all attendees and include the organizer
            all_attendees = @event.users.to_a
            all_attendees.unshift(@event.user) if @event.user.present? && !all_attendees.include?(@event.user)

            mobile_limit  = 2
            desktop_limit = 3
            total_attendees = all_attendees.count
            use_carousel = total_attendees > desktop_limit
          %>

          <div class="attendees-section mt-0" id="attendees-section">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
                <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
              </svg>
              Confirmed Attendees
              <span class="count-badge" id="attendees-count"><%= all_attendees.count %></span>
            </h3>

            <% if use_carousel %>
              <div class="attendees-scroll" id="event-attendees">
                <% all_attendees.each do |user| %>
                  <%= render 'events/attendee_badge', user: user, event: @event %>
                <% end %>
              </div>
            <% else %>

              <div class="attendees-grid" id='event-attendees'>
                <% all_attendees.each do |user| %>
                  <!-- Create an attendee badge partial and render it -->
                  <%= render 'events/attendee_badge', user: user, event: @event %>
                <% end %>
              </div>

            <% end %>

          </div>
        <% end %>

        <!-- Event Feedbacks -->
        <% if @event.feedbacks.any? %>
          <div class="feedbacks-section mt-3">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
              </svg>
              Event Feedback
              <span class="count-badge"><%= @event.feedback_count %></span>
              <span class="average-rating-badge">‚≠ê <%= @event.average_rating %> average</span>
            </h3>
            <div class="feedbacks-grid">
              <% @event.feedbacks.order(created_at: :desc).each do |feedback| %>
                <div class="feedback-card">
                  <div class="feedback-header">
                    <div class="feedback-user">
                      <div class="feedback-avatar">
                        <% if feedback.user.avatar.attached? %>
                          <%= cl_image_tag feedback.user.avatar.key, width: 50, height: 50, crop: :fill, gravity: :face, alt: feedback.user.name, style: "width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" %>
                        <% else %>
                          <%= feedback.user.name&.first&.upcase || '?' %>
                        <% end %>
                      </div>
                      <div>
                        <div class="feedback-user-name"><%= feedback.user.name %></div>
                        <div class="feedback-date"><%= feedback.created_at.strftime("%b %d, %Y") %></div>
                      </div>
                    </div>
                    <div class="feedback-rating">
                      <%= "‚≠ê" * feedback.rating %>
                    </div>
                  </div>
                  <div class="feedback-comment">
                    <%= feedback.comment %>
                  </div>
                  <% if feedback.pictures.attached? %>
                    <div class="feedback-photos">
                      <% feedback.pictures.each do |picture| %>
                        <div class="feedback-photo">
                          <%= image_tag picture, alt: "Event photo" %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

      </div>
    </div>
  </div>
</div>

<script>
  // Convert UTC times to local timezone
  function convertToLocalTime() {
    document.querySelectorAll('.local-time').forEach(function(element) {
      const utcTime = element.dataset.utc;
      if (utcTime) {
        try {
          const date = new Date(utcTime);
          // Verify the date is valid
          if (isNaN(date.getTime())) {
            console.error('Invalid date:', utcTime);
            return;
          }
          const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          };
          element.textContent = date.toLocaleString('en-US', options).replace(',', ' at');
        } catch (error) {
          console.error('Error converting time:', error, utcTime);
        }
      }
    });
  }

  function initMap() {
    const mapElement = document.getElementById("event-map");
    if (!mapElement) return;

    const address = mapElement.dataset.location;
    const geocoder = new google.maps.Geocoder();

    geocoder.geocode({ address: address }, function(results, status) {
      if (status === "OK") {
        const map = new google.maps.Map(mapElement, {
          zoom: 14,
          center: results[0].geometry.location
        });

        new google.maps.Marker({
          position: results[0].geometry.location,
          map: map
        });
      } else {
        console.error("Geocode failed: " + status);
        mapElement.innerHTML = "Map cannot be loaded for this location.";
      }
    });
  }

  // Initialize on page load
  document.addEventListener("turbo:load", function() {
    convertToLocalTime();
    if (typeof google !== "undefined" && google.maps) {
      initMap();
    }
  });

  // Also run on first load (before turbo)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', convertToLocalTime);
  } else {
    convertToLocalTime();
  }

</script>

<script async defer loading="lazy"
        src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_SERVER_KEY'] %>&callback=initMap">
</script>
