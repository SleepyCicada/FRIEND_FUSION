<div class="container mt-4">

  <%= form_with model: @event, local: true, class: "card shadow-sm p-4 rounded-4" do |form| %>

    <!-- Header -->
    <div class="form-header text-center mb-4">
      <h2 class="form-title mb-2">
        <%= @event.new_record? ? "Create Your Event" : "Edit Event" %>
      </h2>
      <p class="text-muted">
        <%= @event.new_record? ? "Bring people together and create memorable experiences" : "Update your event details" %>
      </p>
    </div>

    <!-- Language/Topic Selection -->
    <div class="form-group mb-4">
      <label class="form-label">Language/Topic *</label>

      <% if @topics.size == 1 %>
        <%= form.select :topic_id,
          options_from_collection_for_select(@topics, :id, :topic_name, @event.topic_id),
          {},
          class: "form-select", disabled: true %>
        <%= form.hidden_field :topic_id, value: @event.topic_id %>

        <div class="form-text">
          <span class="badge bg-primary">Topic locked to <%= @topics.first.topic_name %></span>
        </div>
      <% else %>
        <%= form.select :topic_id,
          options_from_collection_for_select(@topics, :id, :topic_name, @event.topic_id),
          { prompt: "Select a language..." },
          class: "form-select", required: true %>
        <div class="form-text">Choose the language community for this event</div>
      <% end %>
    </div>

    <!-- Title -->
    <div class="form-group mb-4">
      <label class="form-label">Event Title *</label>
      <%= form.text_field :title,
          class: "form-control form-control-lg",
          placeholder: "e.g., Summer BBQ & Networking",
          required: true %>
    </div>

    <!-- Description -->
    <div class="form-group mb-4">
      <label class="form-label">Description *</label>
      <%= form.text_area :description,
          class: "form-control",
          rows: 4,
          placeholder: "Tell people what makes this event special...",
          maxlength: 500,
          required: true %>
      <div class="form-text">Share the details and what attendees can expect</div>
    </div>

    <!-- Location -->
    <div class="form-group mb-4">
      <label class="form-label">Location *</label>
      <%= form.text_field :location,
          class: "form-control",
          placeholder: "e.g., Central Park, 123 Main St, or Online",
          required: true %>
    </div>

    <!-- Date & Time -->
    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-4">
          <label class="form-label">Start Date & Time *</label>
          <%= form.datetime_local_field :date_time,
              class: "form-control",
              required: true,
              min: Time.current.strftime("%Y-%m-%dT%H:%M") %>
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group mb-4">
          <label class="form-label">End Date & Time *</label>
          <%= form.datetime_local_field :end_time,
              class: "form-control",
              required: true,
              min: Time.current.strftime("%Y-%m-%dT%H:%M") %>
        </div>
      </div>
    </div>

    <!-- Max Capacity -->
    <div class="form-group mb-4">
      <label class="form-label">Maximum Attendees</label>
      <%= form.number_field :max_capacity,
          class: "form-control",
          min: 1,
          max: 10000,
          placeholder: "Leave empty for unlimited" %>
      <div class="form-text">Optional: Set a limit on attendance</div>
    </div>

    <!-- Image Upload -->
    <div class="form-group mb-4">
      <label class="form-label">Event Cover Image</label>
      <%= form.file_field :image,
          class: "form-control",
          accept: "image/*" %>

      <% if @event.image.attached? %>
        <div class="current-image mt-3">
          <p class="text-muted small mb-2">Current Image:</p>
          <%= image_tag @event.image,
              class: "img-thumbnail rounded-3",
              style: "max-width: 300px;" %>
        </div>
      <% end %>

      <div class="form-text">Upload a JPG, PNG, or GIF image</div>
    </div>

    <!-- Submit -->
    <div class="form-actions text-center mt-4">
      <%= form.submit (@event.new_record? ? "Create Event" : "Update Event"),
          class: "btn btn-primary btn-lg px-5 py-3 rounded-pill shadow-sm" %>
    </div>

  <% end %>

</div>


    <!-- Title -->
    <div class="mb-3">
      <%= form.label :title, "Title", class: "form-label fw-bold" %>
      <%= form.text_field :title, class: "form-control", placeholder: "Event title" %>
    </div>

    <!-- Description -->
    <div class="mb-3">
      <%= form.label :description, "Description", class: "form-label fw-bold" %>
      <%= form.text_area :description, class: "form-control", rows: 3, placeholder: "Describe your event!" %>
    </div>

    <!-- Location -->
    <div class="mb-3">
      <%= form.label :location, "Location", class: "form-label fw-bold" %>
      <%= form.text_field :location, class: "form-control", placeholder: "Where is the event happening?" %>
    </div>

    <!-- Date -->
    <div class="mb-3">
      <%= form.label :date, "Date", class: "form-label fw-bold" %>
      <%= form.date_field :date, class: "form-control" %>
    </div>

    <!-- Time -->
    <div class="mb-3">
      <%= form.label :time, "Time", class: "form-label fw-bold" %>
      <%= form.time_field :time, class: "form-control" %>
    </div>

    <!-- Max Capacity -->
    <div class="mb-3">
      <%= form.label :max_capacity, "Max Capacity", class: "form-label fw-bold" %>
      <%= form.number_field :max_capacity, class: "form-control", min: 1, placeholder: "Optional" %>
    </div>

    <!-- Image Upload -->
    <div class="mb-4">
      <%= form.label :image, "Event Image", class: "form-label fw-bold" %>
      <%= form.file_field :image, class: "form-control" %>

      <% if @event.persisted? && @event.image.attached? %>
        <div class="mt-2">
          <p class="text-muted small mb-1">Current Image:</p>
          <%= image_tag @event.image, class: "rounded-3", style: "width: 150px; height: auto;" %>
        </div>
      <% end %>
    </div>

    <!-- Submit button -->
    <div class="mt-3 text-center">
      <%= form.submit (@event.new_record? ? "Create Event" : "Update Event"),
          class: "btn btn-primary px-4 py-2 rounded-pill fw-semibold" %>
    </div>

  <% end %>

</div>

<style>
  .event-form-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 20px;
    padding: 3rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .form-header {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 1.5rem;
    margin-bottom: 2rem;
  }

  .form-title {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .form-label {
    font-weight: 600;
    color: #495057;
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
  }

  .form-control {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    font-size: 1rem;
  }

  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
  }

  .form-control.is-invalid {
    border-color: #dc3545;
  }

  .form-control.is-valid {
    border-color: #28a745;
  }

  .form-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.5rem;
  }

  .char-counter {
    font-weight: 600;
    color: #495057;
  }

  .invalid-feedback {
    display: none;
    font-size: 0.875rem;
    color: #dc3545;
    margin-top: 0.5rem;
  }

  .form-control.is-invalid ~ .invalid-feedback {
    display: block;
  }

  .image-upload-container {
    position: relative;
  }

  .current-image img {
    border: 3px solid #e9ecef;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    font-weight: 600;
    letter-spacing: 0.5px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
  }

  .form-group {
    position: relative;
  }

  @media (max-width: 768px) {
    .event-form-card {
      padding: 2rem 1.5rem;
    }

    .form-title {
      font-size: 1.5rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('event-form');

    // Character counter for description
    const descriptionField = document.querySelector('[data-validate="description"]');
    const charCounter = document.getElementById('description-counter');

    if (descriptionField && charCounter) {
      descriptionField.addEventListener('input', function() {
        const length = this.value.length;
        charCounter.textContent = length + '/500';

        if (length > 450) {
          charCounter.style.color = '#dc3545';
        } else if (length > 400) {
          charCounter.style.color = '#ffc107';
        } else {
          charCounter.style.color = '#495057';
        }
      });

      // Initialize counter
      charCounter.textContent = descriptionField.value.length + '/500';
    }

    // Validation functions
    const validators = {
      topic: function(value) {
        if (!value || value === '') {
          return 'Please select a language/topic';
        }
        return null;
      },

      title: function(value) {
        if (!value || value.trim().length === 0) {
          return 'Event title is required';
        }
        if (value.trim().length < 3) {
          return 'Title must be at least 3 characters';
        }
        if (value.trim().length > 100) {
          return 'Title must be less than 100 characters';
        }
        return null;
      },

      description: function(value) {
        if (!value || value.trim().length === 0) {
          return 'Description is required';
        }
        if (value.trim().length < 10) {
          return 'Description must be at least 10 characters';
        }
        return null;
      },

      location: function(value) {
        if (!value || value.trim().length === 0) {
          return 'Location is required';
        }
        if (value.trim().length < 3) {
          return 'Location must be at least 3 characters';
        }
        return null;
      },

      date_time: function(value) {
        if (!value) {
          return 'Start date and time are required';
        }
        const selectedDate = new Date(value);
        const now = new Date();
        if (selectedDate <= now) {
          return 'Event must be scheduled in the future';
        }
        return null;
      },

      end_time: function(value) {
        if (!value) {
          return 'End date and time are required';
        }
        const startDateField = document.querySelector('[data-validate="date_time"]');
        if (startDateField && startDateField.value) {
          const startDate = new Date(startDateField.value);
          const endDate = new Date(value);
          if (endDate <= startDate) {
            return 'End time must be after start time';
          }
        }
        return null;
      }
    };

    // Validate field
    function validateField(field) {
      const fieldName = field.dataset.validate;
      const value = field.value;
      const errorDiv = document.getElementById(fieldName + '-error');

      if (!validators[fieldName]) return true;

      const error = validators[fieldName](value);

      if (error) {
        field.classList.add('is-invalid');
        field.classList.remove('is-valid');
        if (errorDiv) errorDiv.textContent = error;
        return false;
      } else {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
      }
    }

    // Add real-time validation
    const fieldsToValidate = form.querySelectorAll('[data-validate]');
    fieldsToValidate.forEach(field => {
      // Validate on blur
      field.addEventListener('blur', function() {
        validateField(this);
      });

      // Validate on input (with debounce for better performance)
      let timeout;
      field.addEventListener('input', function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          if (this.classList.contains('is-invalid') || this.classList.contains('is-valid')) {
            validateField(this);
          }
        }, 300);
      });
    });

    // Validate all fields on form submit
    form.addEventListener('submit', function(e) {
      let isValid = true;

      fieldsToValidate.forEach(field => {
        if (!validateField(field)) {
          isValid = false;
        }
      });

      if (!isValid) {
        e.preventDefault();

        // Scroll to first error
        const firstError = form.querySelector('.is-invalid');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstError.focus();
        }

        // Show alert
        alert('Please fix the errors in the form before submitting.');
      }
    });

    // Image preview
    const imageInput = form.querySelector('[data-preview="image"]');
    if (imageInput) {
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const existingPreview = document.querySelector('.image-preview-new');
            if (existingPreview) {
              existingPreview.remove();
            }

            const preview = document.createElement('div');
            preview.className = 'current-image mt-3 image-preview-new';
            preview.innerHTML = `
              <p class="text-muted small mb-2">Preview:</p>
              <img src="${e.target.result}" class="img-thumbnail rounded-3" style="max-width: 300px; height: auto;">
            `;
            imageInput.closest('.image-upload-container').appendChild(preview);
          };
          reader.readAsDataURL(file);
        }
      });
    }
  });
</script>
