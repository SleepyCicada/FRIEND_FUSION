<div class="feedback-page">
  <div class="container py-5">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <!-- Header Section -->
        <div class="feedback-header text-center mb-5">
          <div class="feedback-icon mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M4.285 9.567a.5.5 0 0 1 .683.183A3.498 3.498 0 0 0 8 11.5a3.498 3.498 0 0 0 3.032-1.75.5.5 0 1 1 .866.5A4.498 4.498 0 0 1 8 12.5a4.498 4.498 0 0 1-3.898-2.25.5.5 0 0 1 .183-.683zM7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5z"/>
            </svg>
          </div>
          <h1 class="feedback-title">Share Your Experience</h1>
          <p class="feedback-subtitle text-muted">Tell us about your experience at <strong><%= @event.title %></strong></p>
        </div>

        <!-- Feedback Form Card -->
        <div class="feedback-form-card">
          <%= form_with model: [@event, @feedback], local: true, class: "feedback-form" do |f| %>
            <% if @feedback.errors.any? %>
              <div class="alert alert-danger alert-modern">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <div>
                  <h5 class="mb-2"><%= pluralize(@feedback.errors.count, "error") %> prevented your feedback from being saved:</h5>
                  <ul class="mb-0">
                    <% @feedback.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            <% end %>

            <!-- Star Rating Section -->
            <div class="form-section">
              <label class="form-label-modern">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                </svg>
                How would you rate this event?
              </label>
              <%= f.select :rating,
                    options_for_select((1..5).map { |i| ["#{"â­" * i} (#{i} star#{"s" if i > 1})", i] }, @feedback.rating),
                    { prompt: "Select a rating" },
                    { class: "form-select form-select-modern", required: true } %>
            </div>

            <!-- Comment Section -->
            <div class="form-section">
              <label class="form-label-modern">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                </svg>
                Share your thoughts
              </label>
              <%= f.text_area :comment,
                    class: "form-control form-control-modern",
                    rows: 6,
                    placeholder: "What did you enjoy? What could be improved? Share your experience with us...",
                    required: true %>
            </div>

            <!-- Pictures Upload Section -->
            <div class="form-section">
              <label class="form-label-modern">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                  <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                </svg>
                Upload event pictures (optional)
              </label>
              <div class="file-upload-wrapper">
                <%= f.file_field :pictures,
                      multiple: true,
                      accept: "image/png,image/jpeg,image/jpg,image/gif",
                      class: "form-control form-control-modern",
                      id: "picture-upload",
                      onchange: "previewImages(event)" %>
                <div class="file-upload-hint">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                  </svg>
                  You can upload multiple images (JPEG, PNG, or GIF). Max 5MB per image.
                </div>
              </div>
              <div id="image-previews" class="image-previews"></div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <%= f.submit "Submit Feedback", class: "btn btn-submit-modern" %>
              <%= link_to "Cancel", @event, class: "btn btn-cancel-modern" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .feedback-page {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
  }

  .feedback-header {
    color: white;
  }

  .feedback-icon {
    color: rgba(255, 255, 255, 0.9);
  }

  .feedback-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
  }

  .feedback-subtitle {
    font-size: 1.125rem;
    color: rgba(255, 255, 255, 0.9) !important;
  }

  .feedback-subtitle strong {
    color: white;
    font-weight: 600;
  }

  .feedback-form-card {
    background: white;
    border-radius: 20px;
    padding: 3rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .form-section {
    margin-bottom: 2rem;
  }

  .form-label-modern {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 1.1rem;
    color: #2d3748;
    margin-bottom: 0.75rem;
  }

  .form-label-modern svg {
    color: #667eea;
  }

  .form-select-modern,
  .form-control-modern {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 0.875rem 1.25rem;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .form-select-modern:focus,
  .form-control-modern:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15);
    outline: none;
  }

  .form-control-modern {
    resize: vertical;
    line-height: 1.6;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2.5rem;
  }

  .btn-submit-modern {
    flex: 1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 1rem 2rem;
    font-size: 1.125rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-submit-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    color: white;
  }

  .btn-cancel-modern {
    background: white;
    color: #718096;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 1rem 2rem;
    font-size: 1.125rem;
    font-weight: 600;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .btn-cancel-modern:hover {
    background: #f7fafc;
    border-color: #cbd5e0;
    color: #4a5568;
  }

  .alert-modern {
    border-radius: 12px;
    border: none;
    padding: 1.25rem;
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .alert-modern svg {
    flex-shrink: 0;
    margin-top: 0.25rem;
  }

  .alert-modern h5 {
    font-size: 1rem;
    font-weight: 600;
  }

  .alert-modern ul {
    padding-left: 1.25rem;
  }

  .file-upload-wrapper {
    position: relative;
  }

  .file-upload-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding: 0.75rem 1rem;
    background: #f7fafc;
    border-radius: 8px;
    color: #718096;
    font-size: 0.875rem;
    line-height: 1.5;
  }

  .file-upload-hint svg {
    flex-shrink: 0;
    color: #667eea;
  }

  .image-previews {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .preview-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .preview-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  }

  .preview-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    display: block;
  }

  .preview-remove {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .preview-remove:hover {
    background: rgba(220, 38, 38, 1);
    transform: scale(1.1);
  }

  .preview-name {
    padding: 0.5rem;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 0.75rem;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  @media (max-width: 768px) {
    .feedback-title {
      font-size: 2rem;
    }

    .feedback-form-card {
      padding: 2rem 1.5rem;
    }

    .form-actions {
      flex-direction: column;
    }

    .image-previews {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
  }
</style>

<script>
  function previewImages(event) {
    const files = event.target.files;
    const previewContainer = document.getElementById('image-previews');
    previewContainer.innerHTML = '';

    Array.from(files).forEach((file, index) => {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();

        reader.onload = function(e) {
          const previewItem = document.createElement('div');
          previewItem.className = 'preview-item';
          previewItem.innerHTML = `
            <img src="${e.target.result}" alt="${file.name}">
            <div class="preview-name">${file.name}</div>
            <button type="button" class="preview-remove" onclick="removePreview(this, ${index})" title="Remove image">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
              </svg>
            </button>
          `;
          previewContainer.appendChild(previewItem);
        };

        reader.readAsDataURL(file);
      }
    });
  }

  function removePreview(button, index) {
    // Remove the preview item
    button.parentElement.remove();

    // Get the file input
    const fileInput = document.getElementById('picture-upload');
    const dt = new DataTransfer();
    const files = fileInput.files;

    // Add all files except the one at the specified index
    for (let i = 0; i < files.length; i++) {
      if (i !== index) {
        dt.items.add(files[i]);
      }
    }

    // Update the file input with the new file list
    fileInput.files = dt.files;

    // If no files left, clear the preview container
    if (dt.files.length === 0) {
      document.getElementById('image-previews').innerHTML = '';
    }
  }
</script>
