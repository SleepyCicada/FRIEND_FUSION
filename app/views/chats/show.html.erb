<div class="chat-container">
  <!-- Chat Header -->
  <div class="chat-header mb-3">
    <!-- Title row -->
    <div class="d-flex align-items-center mb-1">
      <!-- Back button -->
      <button class="btn btn-outline-secondary btn-sm me-2 rounded-pill go-back-chat" onclick="goBackChat()" style="padding: 0.4rem 1rem; display: inline-flex; align-items: center; gap: 0.3rem;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
        </svg>
        <span>Back</span>
      </button>
      <h3 class="mb-0 d-flex align-items-center flex-wrap">
        <%# <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chat-dots me-2" viewBox="0 0 16 16">
          <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
          <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
        </svg> %>
        <%= @chat.event.title %>
      </h3>
    </div>

    <!-- Event Details Button -->
    <div class="mb-1 d-flex justify-content-end">
      <%= link_to "Event Details", event_path(@chat.event), class: "btn btn-sm btn-outline-primary rounded-pill" %>
    </div>

    <!-- Attendees Info -->
    <p class="text-muted mb-0 small">
      <span id="online-count"><%= @chat.event.confirmations.count %></span> attendees
    </p>
  </div>


<script>
function goBackChat() {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = "/"; // fallback URL
  }
}
</script>

  <!-- Messages Container -->
  <div id="chat-messages" class="chat-messages">
    <% if @messages.empty? %>
      <div class="empty-chat-state">
        <div class="empty-icon">ðŸ’¬</div>
        <h5>Start the conversation!</h5>
        <p class="text-muted">Be the first to say hello or ask Kai below for help.</p>
      </div>
    <% else %>
      <% @messages.each do |msg| %>
        <%= render partial: 'messages/message', locals: { message: msg } %>
      <% end %>
    <% end %>

    <!-- Typing Indicator (hidden by default) -->
    <div id="typing-indicator" class="typing-indicator" style="display: none;">
      <div class="message-bubble ai-bubble">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Smart Reply Suggestions (shown when AI generates them) -->
  <div id="smart-replies" class="smart-replies-container" style="display: none;">
    <div class="smart-replies-label">Quick Replies:</div>
    <div id="smart-replies-list" class="smart-replies-list"></div>
  </div>

  <!-- Message Input Form -->
  <div class="chat-input-container">
    <%= form_with url: chat_messages_path(@chat), method: :post, data: { turbo_stream: true }, class: "chat-input-form", id: "message-form" do |form| %>
      <div class="input-group">
        <%= form.text_field :message_text,
            placeholder: "Type your message...",
            class: "form-control chat-input",
            required: true,
            id: "message-input",
            autocomplete: "off" %>
        <%= form.hidden_field :chat_id, value: @chat.id %>

        <%= form.submit "Send", class: "btn btn-primary", id: "send-btn" %>
      </div>
    <% end %>
  </div>
</div>

<!-- AI Features Section -->
<div class="ai-features-section">
  <div class="container">
    <div class="row g-4">
      <!-- Ask AI Section -->
      <div class="col-lg-6">
        <div class="feature-card">
          <div class="feature-header">
            <h4 class="feature-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828l.645-1.937zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.734 1.734 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.734 1.734 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.734 1.734 0 0 0 3.407 2.31l.387-1.162zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L10.863.1z"/>
              </svg>
              Ask Kai
            </h4>
          </div>

          <div id="ask-ai-responses" class="feature-content ask-ai-content">
            <p class="empty-state-text">Ask Kai anything! Generate conversation starters, get tips, or ask questions about the event.</p>
          </div>

          <%= form_with url: ask_ai_chat_path(@chat.id), method: :post, data: { turbo_stream: true }, class: "ask-ai-form", id: "ask-ai-form" do |form| %>
            <div class="ask-ai-input-group">
              <%= form.text_area :question,
                  placeholder: "Ask Kai anything... (e.g., 'Generate conversation starters' or 'Give me tips for this event')",
                  class: "form-control ask-ai-input",
                  rows: 2,
                  id: "ask-ai-input",
                  autocomplete: "off" %>
              <%= form.submit "Ask Kai", class: "btn btn-ask-ai", id: "ask-ai-submit-btn" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Chat Summary Card -->
      <div class="col-lg-6">
        <div class="feature-card">
          <div class="feature-header">
            <h4 class="feature-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                <path d="M3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 3.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
              </svg>
              Chat Summary
            </h4>
            <%= button_to summary_chat_path(@chat.id),
                  method: :get,
                  data: { turbo_stream: true },
                  class: "btn-feature-action",
                  id: "summary-button" do %>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
              </svg>
              Generate
            <% end %>
          </div>

          <div id="summary-loading" class="loading-state" style="display: none;">
            <div class="spinner-border spinner-border-sm"></div>
            <span>Generating summary...</span>
          </div>

          <div id="chat-summary" class="feature-content">
            <p class="empty-state-text">No summary generated yet. Click Generate to create one!</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbo:before-fetch-request", (e) => {
    if (e.target.id === "summary-button") {
      document.getElementById("summary-loading").style.display = "flex";
    }
    if (e.target.id === "chat-starter-button") {
      document.getElementById("chat-starter-loading").style.display = "flex";
    }
  });
</script>

<script>
  // Use turbo:load instead of DOMContentLoaded to work with Turbo navigation
  document.addEventListener('turbo:load', function() {
    console.log('Chat page loaded (turbo:load event)');
    const chatMessages = document.getElementById('chat-messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const typingIndicator = document.getElementById('typing-indicator');
    const chatId = <%= @chat.id %>;

    // Auto-scroll to bottom
    function scrollToBottom() {
      if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    // Initial scroll
    scrollToBottom();

    // Handle form submission
    if (messageForm) {
      console.log('Attaching submit event listener to message form');
      messageForm.addEventListener('submit', function(e) {
        const messageText = messageInput.value.trim();
        console.log('Form submit handler called, message:', messageText);

        if (!messageText) {
          e.preventDefault();
          return;
        }

        // Clear input immediately on submit, before Turbo processes it
        setTimeout(() => {
          if (messageInput) {
            console.log('Clearing input immediately on submit');
            messageInput.value = '';
          }
        }, 50);
      });
    } else {
      console.error('Message form not found!');
    }

    // Fetch and display smart reply suggestions
    function fetchSmartReplies() {
      const smartRepliesContainer = document.getElementById('smart-replies');
      const smartRepliesList = document.getElementById('smart-replies-list');

      // Only fetch if there are messages
      const messageCount = chatMessages.querySelectorAll('.message-wrapper').length;
      if (messageCount < 2 || Math.random() > 0.6) {
        return; // Don't always show them
      }

      fetch(`/chats/${chatId}/messages/smart_replies`)
        .then(response => response.json())
        .then(data => {
          if (data.replies && data.replies.length > 0) {
            smartRepliesList.innerHTML = '';

            data.replies.forEach(reply => {
              const chip = document.createElement('button');
              chip.className = 'smart-reply-chip';
              chip.textContent = reply;
              chip.addEventListener('click', function() {
                messageInput.value = reply;
                messageInput.focus();
                smartRepliesContainer.style.display = 'none';
              });
              smartRepliesList.appendChild(chip);
            });

            smartRepliesContainer.style.display = 'block';

            // Auto-hide after 10 seconds
            setTimeout(() => {
              smartRepliesContainer.style.display = 'none';
            }, 10000);
          }
        })
        .catch(error => {
          // Failed to fetch smart replies - silently fail
        });
    }

    // Turbo Stream handling
    document.addEventListener('turbo:submit-end', function(e) {
      console.log('turbo:submit-end fired, target:', e.target.id);
      if (e.target.id === 'message-form') {
        console.log('Processing after form submit');

        // Hide typing indicator after AI responds
        setTimeout(() => {
          if (typingIndicator) {
            typingIndicator.style.display = 'none';
          }
        }, 1500);

        // Scroll to bottom after new message
        setTimeout(scrollToBottom, 100);

        // Fetch smart replies occasionally
        setTimeout(fetchSmartReplies, 1500);

        // Focus the input
        if (messageInput) {
          messageInput.focus();
        }
      }
    });

    // Handle summary button
    const summaryButton = document.getElementById('summary-button');
    if (summaryButton) {
      summaryButton.addEventListener('click', function() {
        const loading = document.getElementById('summary-loading');
        if (loading) loading.style.display = 'block';
      });
    }

    // Load smart replies on page load occasionally
    setTimeout(fetchSmartReplies, 2000);
  });

  // Turbo Stream handlers for new messages
  document.addEventListener('turbo:before-fetch-request', (e) => {
    if (e.target.id === 'chat-starter-button') {
      document.getElementById('chat-starter-loading').style.display = 'block';
    }
  });
</script>
